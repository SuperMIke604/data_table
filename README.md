# 数据库自动更新器 (TavernDB Auto Updater)

这是一个 SillyTavern 第三方扩展，用于通过增量更新模式自动维护世界书中的 JSON 数据库条目。

## 功能特性

- 🔄 **自动增量更新**: 自动解析 AI 回复中的表格编辑指令（`<tableThink>`, `<tableCheck>`, `<tableEdit>`），更新表格数据
- 📊 **多表格管理**: 支持管理多个数据表格（全局数据表、主角信息、重要角色表、技能表、物品表、任务表、总结表、故事主线等）
- 🌍 **世界书同步**: 自动将表格数据转换为可读格式并同步到世界书
- 🎯 **智能触发**: 可配置的自动更新触发条件（更新频率、Token阈值等）
- 🔧 **灵活配置**: 支持自定义 API 配置、提示词模板、表格模板等
- 💾 **数据导入导出**: 支持 JSON 格式的数据和模板导入导出

## 安装方法

1. 将扩展文件夹放置到 SillyTavern 的 `scripts/extensions` 目录下
2. 重启 SillyTavern 或在扩展管理界面中启用该扩展

## 使用方法

### 基本设置

1. **配置 API**: 在扩展设置中配置自定义 API 或选择使用主 API
2. **设置提示词**: 导入或编辑角色卡提示词，确保 AI 能正确输出表格编辑指令
3. **配置表格模板**: 导入或使用默认的表格模板，定义数据结构

### 自动更新

扩展会在以下条件下自动触发更新：

- AI 生成新回复后（可通过配置禁用）
- 未记录的消息数量达到配置的阈值
- 上下文 Token 数量超过配置的阈值

### 手动更新

点击"手动更新数据库"按钮可以手动触发一次数据库更新。

## 表格编辑指令格式

AI 需要按照以下格式输出表格编辑指令：

```
<tableThink>
<!--
思考过程：剧情摘要、操作判定等
-->
</tableThink>

<tableCheck>
<!--
数据一致性检查、编码索引检查等
-->
</tableCheck>

<tableEdit>
<!--
insertRow(0, {"0": "值1", "1": "值2"})
updateRow(1, 0, {"0": "新值"})
deleteRow(2, 0)
-->
</tableEdit>
```

## 配置说明

### API 配置
- **自定义 API**: 可以配置独立的 API URL、密钥和模型
- **主 API**: 使用 SillyTavern 的主 API 配置

### 自动更新设置
- **更新频率**: 最新 N 层不更新（默认：1）
- **批处理大小**: 每次更新处理的楼层数（默认：1）
- **Token 阈值**: 触发更新的最小 Token 数量（默认：500）

### 世界书配置
- **注入目标**: 选择数据注入到哪个世界书
- **世界书来源**: 选择用于 AI 读取上下文的世界书

## 数据格式

数据库使用 JSON 格式存储，包含以下结构：

```json
{
  "sheet_xxx": {
    "uid": "sheet_xxx",
    "name": "表格名称",
    "content": [[null, "列1", "列2", ...], [null, "值1", "值2", ...]],
    "sourceData": { ... }
  },
  "mate": {
    "type": "chatSheets",
    "version": 1
  }
}
```

## 注意事项

1. 首次使用时需要配置 API 和提示词
2. 确保 AI 模型能够理解和执行表格编辑指令
3. 建议定期导出数据备份
4. 表格模板结构变更后需要重新初始化数据库

## 版本信息

- **版本**: 1.0.0
- **作者**: Cline (AI Assisted)
- **SillyTavern 版本要求**: >= 1.10.0

## 许可证

请遵循相关开源许可证。

## 支持与反馈

如有问题或建议，请在项目仓库中提交 Issue。

